# 小乔智能设备 - 多实例模式烧录工具

## 概述

多实例模式是小乔智能设备烧录工具的重要扩展，支持多台ESP32设备的并发自动烧录。通过为每个设备创建独立的工作环境，实现真正的并行处理，大大提高批量设备生产的效率。

## 核心特性

### ✨ 主要功能

- **🔄 并发处理**: 支持多台ESP32设备同时烧录，最大化生产效率
- **🏗️ 工作目录隔离**: 每个设备独立的工作环境，避免配置冲突
- **📊 实时监控**: 图形界面实时显示每个设备的状态和进度
- **🔧 智能管理**: 自动检测设备、状态管理、错误恢复
- **🎯 用户友好**: 现代化GUI界面，操作简单直观

### 💡 技术优势

- **线程池管理**: 高效的并发任务调度
- **资源隔离**: 独立的配置文件和编译输出
- **错误处理**: 完善的重试机制和错误恢复
- **状态同步**: 线程安全的状态管理
- **内存管理**: 自动清理临时文件和工作目录

## 系统架构

```
多实例模式架构图
┌─────────────────────────────────────────────────────────────┐
│                    多设备管理界面 (UI)                        │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐              │
│  │   设备1     │ │    设备2    │ │    设备N    │              │
│  │  状态监控   │ │   状态监控  │ │   状态监控  │              │
│  └─────────────┘ └─────────────┘ └─────────────┘              │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                  多设备管理器 (Manager)                      │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              线程池 (ThreadPool)                        │ │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐    │ │
│  │  │ 工作线程1│  │ 工作线程2│  │ 工作线程3│  │ 工作线程N│    │ │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘    │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                   工作目录管理器                             │
│  instances/                                                 │
│  ├── device_COM3_20241214_001/                             │
│  │   ├── main/                                             │
│  │   ├── sdkconfig                                         │
│  │   ├── build/                                            │
│  │   └── device_info.json                                  │
│  ├── device_COM4_20241214_002/                             │
│  │   ├── main/                                             │
│  │   ├── sdkconfig                                         │
│  │   ├── build/                                            │
│  │   └── device_info.json                                  │
│  └── ...                                                   │
└─────────────────────────────────────────────────────────────┘
```

## 安装和依赖

### 环境要求

- **Python**: 3.8+
- **ESP-IDF**: v5.3.2+ (推荐v5.4.1)
- **操作系统**: Windows 10/11, Linux, macOS

### 依赖安装

```bash
# 安装Python依赖
pip install PySide6 pyserial requests

# 确保ESP-IDF环境已正确安装和配置
# Windows示例:
C:\Users\1\esp\v5.4.1\esp-idf\export.bat

# Linux/macOS示例:
source ~/esp/esp-idf/export.sh
```

### 文件结构

```
xiaozhi-esp32/
├── workspace_manager.py          # 工作目录管理器
├── device_instance.py           # 设备实例封装
├── multi_device_manager.py      # 多设备管理器
├── shaolu_ui_multi_simple.py    # 多设备UI界面
├── demo_multi_device.py         # 功能演示脚本
├── shaolu_ui.py                 # 原始单设备UI (已修改)
└── instances/                   # 设备工作目录 (自动创建)
    ├── device_COM3_xxx/
    ├── device_COM4_xxx/
    └── ...
```

## 快速开始

### 1. 功能验证

首先运行演示脚本验证所有模块正常工作：

```bash
python demo_multi_device.py
```

预期输出：
```
🚀 多实例模式演示开始
==================================================

=== 工作目录管理器演示 ===
1. 创建项目模板...
   ✓ 项目模板创建成功
...
📊 演示结果总结
成功测试: 5/5
🎉 所有功能演示成功！多实例模式已完整实现
```

### 2. 启动多设备UI

```bash
python shaolu_ui_multi_simple.py
```

### 3. 基本操作流程

1. **连接设备**: 将多台ESP32设备通过USB连接到计算机
2. **自动检测**: 点击"自动检测设备"按钮
3. **确认设备**: 在设备列表中确认检测到的设备
4. **开始烧录**: 点击"开始全部"按钮开始批量烧录
5. **监控进度**: 通过表格实时查看每个设备的状态和进度

## 详细使用指南

### 设备管理

#### 自动检测设备

多设备UI会自动检测连接的ESP32设备：

```python
# 支持的USB转串口芯片
- CP210x (Silicon Labs)
- CH340/CH341 (WCH)
- FTDI系列
- 其他USB Serial设备
```

#### 手动添加设备

如果自动检测失败，可以手动添加：

1. 点击"手动添加设备"按钮
2. 输入串口名称 (如: COM3, /dev/ttyUSB0)
3. 设备将被添加到设备列表

#### 设备状态说明

| 状态 | 描述 | 颜色标识 |
|------|------|----------|
| 空闲 | 设备已连接，等待开始 | 灰色 |
| 检测中 | 正在检测设备连接 | 黄色 |
| 获取MAC | 正在获取设备MAC地址 | 黄色 |
| 注册中 | 正在向云平台注册设备 | 黄色 |
| 更新配置 | 正在更新设备配置文件 | 黄色 |
| 编译中 | 正在编译固件 | 蓝色 |
| 烧录中 | 正在烧录固件到设备 | 橙色 |
| 完成 | 烧录成功完成 | 绿色 |
| 失败 | 烧录过程失败 | 红色 |
| 已取消 | 用户手动取消 | 灰色 |

### 配置选项

#### 默认设备配置

- **设备类型**: esp32, esp32s2, esp32s3, esp32c3
- **设备版本**: 默认1.0.0
- **ESP-IDF路径**: 可配置多个版本路径

#### 并发设置

- **最大并发数**: 1-10个设备同时处理
- **推荐设置**: 4-6个设备 (根据计算机性能)

### 批量操作

#### 开始全部设备

```python
# 同时开始处理所有空闲状态的设备
# 每个设备将执行完整的烧录流程：
# 1. 获取MAC地址
# 2. 注册设备到云平台
# 3. 更新配置文件
# 4. 编译固件
# 5. 烧录固件
```

#### 停止全部设备

```python
# 安全停止所有正在进行的设备处理
# 正在执行的操作会被中断
# 工作目录会被保留以便后续分析
```

#### 单设备操作

每个设备行都有独立的"开始"和"停止"按钮，支持精确控制单个设备的处理。

## 高级功能

### 工作目录管理

#### 自动清理

系统会自动清理超过24小时的旧工作目录：

```python
# 手动清理
from workspace_manager import WorkspaceManager
manager = WorkspaceManager()
cleaned_count = manager.cleanup_old_workspaces(max_age_hours=24)
```

#### 工作目录结构

每个设备的工作目录包含：

```
device_COM3_20241214_150000/
├── main/                    # 项目源码
├── managed_components/      # 依赖组件
├── CMakeLists.txt          # 构建配置
├── sdkconfig               # 设备特定配置
├── build/                  # 编译输出
├── device_info.json        # 设备信息
└── device_status.json      # 设备状态
```

### 错误处理和恢复

#### 自动重试机制

- **获取MAC地址**: 最多重试3次
- **设备注册**: 最多重试3次
- **固件烧录**: 最多重试3次，每次间隔10秒

#### 错误诊断

常见错误及解决方案：

| 错误类型 | 可能原因 | 解决方案 |
|----------|----------|----------|
| 串口连接失败 | 设备断开或被占用 | 检查连接，关闭其他串口程序 |
| MAC获取失败 | esptool问题 | 确认ESP-IDF环境正确安装 |
| 设备注册失败 | 网络连接问题 | 检查网络连接和API服务状态 |
| 编译失败 | 代码或配置错误 | 检查项目文件和ESP-IDF版本 |
| 烧录失败 | 设备通信问题 | 检查设备连接和驱动程序 |

### 性能优化

#### 并发数调优

```python
# 根据系统性能调整并发数
# CPU密集型: 2-4个设备
# I/O密集型: 4-8个设备
# 高性能系统: 6-10个设备

# 监控系统资源使用情况
# CPU使用率应保持在80%以下
# 内存使用合理，避免交换
```

#### 资源管理

- 编译时跳过清理步骤 (skip_clean=True)
- 及时清理完成的工作目录
- 监控磁盘空间使用

## API参考

### WorkspaceManager

```python
class WorkspaceManager:
    def __init__(self, base_path=None):
        """初始化工作目录管理器"""
    
    def create_device_workspace(self, device_id, port=None):
        """为设备创建独立工作目录"""
    
    def cleanup_workspace(self, workspace_path):
        """清理指定工作目录"""
    
    def list_workspaces(self):
        """列出所有工作目录"""
```

### DeviceInstance

```python
class DeviceInstance:
    def __init__(self, device_id: str, port: str = None):
        """创建设备实例"""
    
    def update_status(self, status: DeviceStatus, progress: int = None, message: str = None):
        """更新设备状态"""
    
    def set_mac_address(self, mac_address: str):
        """设置MAC地址"""
    
    def set_client_info(self, client_id: str, bind_key: str = None):
        """设置客户端信息"""
```

### MultiDeviceManager

```python
class MultiDeviceManager:
    def __init__(self, idf_path: str = None):
        """创建多设备管理器"""
    
    def add_device(self, device_id: str, port: str) -> DeviceInstance:
        """添加设备"""
    
    def start_device_processing(self, device_id: str, auto_all_steps: bool = True) -> bool:
        """开始处理设备"""
    
    def start_all_devices_processing(self, auto_all_steps: bool = True) -> int:
        """开始处理所有设备"""
    
    def get_statistics(self) -> Dict[str, int]:
        """获取统计信息"""
```

## 故障排除

### 常见问题

#### Q: UI无法启动，提示PySide6错误
A: 安装PySide6依赖：`pip install PySide6`

#### Q: 检测不到ESP32设备
A: 
1. 检查USB驱动是否正确安装
2. 确认设备管理器中显示串口
3. 关闭其他占用串口的程序 (如Arduino IDE)

#### Q: 编译失败，提示ESP-IDF环境问题
A:
1. 确认ESP-IDF已正确安装
2. 执行环境设置脚本 (export.bat/export.sh)
3. 在UI中设置正确的ESP-IDF路径

#### Q: 设备注册失败
A:
1. 检查网络连接
2. 确认管理员凭证配置正确
3. 检查防火墙设置

#### Q: 多设备同时烧录时出现冲突
A:
1. 降低并发数设置
2. 检查系统资源使用情况
3. 确保每个设备使用不同的串口

### 调试模式

启用详细日志输出：

```python
import logging
logging.basicConfig(level=logging.DEBUG)

# 或者在命令行运行
python shaolu_ui_multi_simple.py --debug
```

### 性能监控

```python
# 监控设备处理统计
stats = device_manager.get_statistics()
print(f"活动设备: {stats['active']}")
print(f"完成设备: {stats['completed']}")
print(f"失败设备: {stats['failed']}")

# 监控工作目录使用
workspaces = workspace_manager.list_workspaces()
print(f"工作目录数量: {len(workspaces)}")
```

## 最佳实践

### 设备准备

1. **驱动安装**: 确保所有ESP32设备的USB驱动正确安装
2. **连接检查**: 使用单设备模式测试每个设备的连接
3. **批量准备**: 一次连接4-6个设备获得最佳性能

### 操作流程

1. **环境检查**: 运行演示脚本验证环境
2. **设备检测**: 使用自动检测功能添加设备
3. **配置验证**: 检查ESP-IDF路径和设备配置
4. **分批处理**: 对于大量设备，分批进行处理
5. **结果验证**: 确认所有设备烧录成功

### 资源管理

1. **定期清理**: 定期清理旧的工作目录
2. **磁盘监控**: 监控磁盘空间，避免空间不足
3. **内存管理**: 处理大量设备时注意内存使用
4. **日志轮转**: 定期清理或归档日志文件

## 更新日志

### v1.0.0 (2024-12-14)
- ✨ 初始版本发布
- 🎯 支持多设备并发烧录
- 🏗️ 工作目录隔离机制
- 📊 图形界面和实时监控
- 🔧 完整的错误处理和重试机制

## 技术支持

### 贡献指南

欢迎贡献代码和提出改进建议！

### 反馈渠道

- 📧 邮件: support@example.com
- 🐛 问题报告: 通过GitHub Issues
- 💬 讨论: 项目讨论区

### 许可证

本项目基于MIT许可证开源。

---

**多实例模式让ESP32批量生产变得简单高效！** 🚀 